{% extends "base.html" %}
{% block title %}Parent View{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='parent.css') }}">
{% endblock %}

{% block content %}
<div id="parent-view">
  <div class="text-center">
    <h1 class="mb-2">üë®‚Äçüë©‚Äçüëß Parent View</h1>
    <p class="lead text-muted mb-4">
      Search and analyze your child‚Äôs weekly digital reflections.
    </p>
  </div>

  <!-- Modal Popup for User ID + Week -->
  <div id="parent-popup" class="popup-overlay">
    <div class="popup-box">
      <h3>üîé View Scrapbook</h3>

      <label for="popup-user-id">User ID</label>
      <input
        type="number"
        id="popup-user-id"
        placeholder="e.g. 1"
        class="form-control mb-3"
      >

      <form id="week-form" onsubmit="event.preventDefault(); confirmParentInputs();">
        <!-- Native HTML5 week picker -->
        <div class="nativeWeekPicker mb-3">
          <label for="popup-week">Select Week</label>
          <input
            id="popup-week"
            type="week"
            name="week"
            min="2020-W01"
            max="2030-W53"
            required
            class="form-control"
          />
          <span class="validity"></span>
        </div>

        <!-- Fallback for Safari/Firefox -->
        <p class="fallbackLabel">Select Week</p>
        <div class="fallbackWeekPicker mb-3">
          <div class="d-flex gap-3 align-items-end">
            <div>
              <label for="fallbackWeek">Week:</label>
              <select id="fallbackWeek" name="week" class="form-select"></select>
            </div>
            <div>
              <label for="fallbackYear">Year:</label>
              <select id="fallbackYear" name="year" class="form-select"></select>
            </div>
          </div>
        </div>
      </form>

      <div class="d-flex justify-content-between gap-2">
        <button
          class="btn btn-secondary w-50"
          onclick="window.location.href='/'"
        >
          Cancel
        </button>
        <button
          class="btn btn-primary w-50"
          onclick="confirmParentInputs()"
        >
          Load
        </button>
      </div>
    </div>
  </div>

  <div class="text-end">
    <button
      class="btn btn-secondary mb-3"
      onclick="generateSummary()"
    >
      üß† Generate Summary
    </button>
  </div>

  <div id="activity-list" class="results"></div>
  <div id="summary" class="summary mt-4"></div>

  <!-- Insight & Resources: Side-by-side layout -->
  <div class="row mt-5" id="insight-resources">
    <div class="col-md-7 mb-4">
      <h2 class="mb-3 text-center">üìä Mental Health & Screen Time Insight</h2>
      <p class="text-muted text-center mb-4">
        A visual summary comparing children's screen time with their likelihood of needing mental health treatment.
      </p>
      <img
        src="{{ url_for('static', filename='assets/Mental Health.jpg') }}"
        alt="Mental Health and Screen Time Chart"
        class="img-fluid rounded shadow w-100"
        style="max-height: 650px; object-fit: contain;"
      >
      <p class="text-center mt-2">
        <small class="text-muted">
          Source:
          <a
            href="https://dataverse.harvard.edu/d...i:10.7910/DVN/1WWCA5"
            target="_blank"
            rel="noopener noreferrer"
          >
            Screentime vs Mental Health Dataset (Harvard Dataverse)
          </a>
        </small>
      </p>
    </div>
    <div class="col-md-5">
      <h2 class="mb-3 text-center">üìö Helpful Resources</h2>
      <div class="resource-card mb-3">
        <div class="resource-icon">üßí</div>
        <div>
          <h5 class="resource-title">Beyond Blue</h5>
          <p>Support for anxiety, depression, and mental health.</p>
          <a href="https://www.beyondblue.org.au/" target="_blank">
            Visit Beyond Blue
          </a>
        </div>
      </div>
      <div class="resource-card">
        <div class="resource-icon">üë™</div>
        <div>
          <h5 class="resource-title">Raising Children Network</h5>
          <p>Videos, articles, and apps covering parenting topics by age group.</p>
          <a href="https://raisingchildren.net.au/" target="_blank">
            Visit Raising Children Network
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const nativePicker   = document.querySelector(".nativeWeekPicker");
      const fallbackPicker = document.querySelector(".fallbackWeekPicker");
      const fallbackLabel  = document.querySelector(".fallbackLabel");
      const testInput      = document.createElement("input");

      // hide fallback by default
      fallbackPicker.style.display = "none";
      fallbackLabel.style.display  = "none";

      // feature-detect <input type="week">
      testInput.type = "week";
      if (testInput.type === "text") {
        // show fallback
        nativePicker.style.display   = "none";
        fallbackPicker.style.display = "block";
        fallbackLabel.style.display  = "block";

        populateYears();
        // initial weeks for the default year
        const yearSelect = document.querySelector("#fallbackYear");
        populateWeeks(yearSelect.value);

        // update weeks when year changes
        yearSelect.addEventListener("change", () => {
          populateWeeks(yearSelect.value);
        });
      }

      // compute the Monday of ISO week
      function getISOWeekStart(year, week) {
        const jan4 = new Date(year, 0, 4);
        const day = jan4.getDay() || 7;
        const isoWeek1Monday = new Date(jan4);
        isoWeek1Monday.setDate(jan4.getDate() - (day - 1));
        const weekStart = new Date(isoWeek1Monday);
        weekStart.setDate(isoWeek1Monday.getDate() + (week - 1) * 7);
        return weekStart;
      }

      // get ISO week number of a date
      function getISOWeekNumber(date) {
        const tmp = new Date(date.valueOf());
        const day = tmp.getDay() || 7;
        tmp.setDate(tmp.getDate() + 4 - day);
        const yearStart = new Date(Date.UTC(tmp.getFullYear(), 0, 1));
        return Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
      }

      // how many ISO weeks in a year
      function weeksInYear(year) {
        const dec31 = new Date(year, 11, 31);
        const w = getISOWeekNumber(dec31);
        return w === 1 ? 52 : w;
      }

      // human‚Äêfriendly date formatting (e.g. "1 Jan")
      function formatDate(date) {
        return date.toLocaleDateString('en-GB', {
          day:   'numeric',
          month: 'short'
        });
      }

      // fill the week <select> with "W01 (1 Jan ‚Äì 7 Jan)" etc.
      function populateWeeks(year) {
        const weekSelect = document.querySelector("#fallbackWeek");
        weekSelect.innerHTML = "";
        const total = weeksInYear(parseInt(year, 10));
        for (let i = 1; i <= total; i++) {
          const start = getISOWeekStart(year, i);
          const end   = new Date(start);
          end.setDate(start.getDate() + 6);
          const num   = i < 10 ? `0${i}` : `${i}`;
          const label = `${num} (${formatDate(start)} ‚Äì ${formatDate(end)})`;
          const opt   = document.createElement("option");
          opt.value       = num;
          opt.textContent = label;
          weekSelect.appendChild(opt);
        }
      }

      // fill the year <select>
      function populateYears() {
        const yearSelect  = document.querySelector("#fallbackYear");
        const currentYear = new Date().getFullYear();
        for (let y = currentYear - 5; y <= currentYear + 5; y++) {
          const opt = document.createElement("option");
          opt.value       = y;
          opt.textContent = y;
          if (y === currentYear) opt.selected = true;
          yearSelect.appendChild(opt);
        }
      }
    });
  </script>

  <!-- existing logic for fetching & rendering -->
  <script src="{{ url_for('static', filename='parent.js') }}"></script>
{% endblock %}
