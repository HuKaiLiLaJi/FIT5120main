{% extends "base.html" %}
{% block title %}Parent View{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='parent.css') }}">
{% endblock %}

{% block content %}
<div id="parent-view">
  <div class="text-center">
    <h1 class="mb-2">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parent View</h1>
    <p class="lead text-muted mb-4">
      Search and analyze your childâ€™s weekly digital reflections.
    </p>
  </div>

  <!-- Modal Popup for User ID + Week -->
  <div id="parent-popup" class="popup-overlay">
    <div class="popup-box">
      <h3>ğŸ” View Scrapbook</h3>

      <label for="popup-user-id">User ID</label>
      <input type="number" id="popup-user-id" placeholder="e.g. 1" class="form-control mb-3">

      <form id="week-form" onsubmit="event.preventDefault(); confirmParentInputs();">
        <div class="nativeWeekPicker mb-3">
          <label for="popup-week">Select Week</label>
          <input id="popup-week" type="week" name="week" min="2020-W01" max="2030-W53" required class="form-control"/>
          <span class="validity"></span>
        </div>

        <p class="fallbackLabel">Select Week</p>
        <div class="fallbackWeekPicker mb-3">
          <div class="d-flex gap-3 align-items-end">
            <div>
              <label for="fallbackWeek">Week:</label>
              <select id="fallbackWeek" name="week" class="form-select"></select>
            </div>
            <div>
              <label for="fallbackYear">Year:</label>
              <select id="fallbackYear" name="year" class="form-select"></select>
            </div>
          </div>
        </div>
      </form>

      <div class="d-flex justify-content-between gap-2">
        <button class="btn btn-secondary w-50" onclick="window.location.href='/'">Cancel</button>
        <button class="btn btn-primary w-50" onclick="confirmParentInputs()">Load</button>
      </div>
    </div>
  </div>

  <!-- Hidden Fields -->
  <input type="hidden" id="user-id">
  <input type="hidden" id="week-select">

  <!-- AIâ€Generated Summary -->
  <div class="mt-4">
    <h3>ğŸ§  Weekly AI Summary</h3>
    <p class="text-muted small mb-3">
      Disclaimer: This summary is generated by DeepSeek AI. Prompts and roles are assigned according to each use case. Please do not include any real names, contacts, or addresses.
    </p>
    <div class="text-end mb-3">
      <button class="btn btn-secondary" onclick="generateSummary()">ğŸ§  Generate Summary</button>
    </div>
    <div id="summary" class="summary"></div>
  </div>

  <!-- Activity Entries -->
  <div id="activity-list" class="results mt-4"></div>

  <!-- Insight & Resources -->
  <div class="row mt-5" id="insight-resources">
    <div class="col-md-7 mb-4">
      <h2 class="mb-3 text-center">ğŸ“Š Mental Health & Screen Time Insight</h2>
      <p class="text-muted text-center mb-4">
        A visual summary comparing children's screen time with their likelihood of needing mental health treatment.
      </p>
      <img src="{{ url_for('static', filename='assets/Mental Health.jpg') }}" alt="Mental Health and Screen Time Chart"
           class="img-fluid rounded shadow w-100"
           style="max-height: 650px; object-fit: contain;">
      <p class="text-center mt-2">
        <small class="text-muted">
          Source:
          <a href="https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/1WWCA5"
             target="_blank" rel="noopener noreferrer">
            Screentime vs Mental Health Dataset (Harvard Dataverse)
          </a>
        </small>
      </p>
    </div>

    <div class="col-md-5" id="supporting-resources">
      <h2 class="text-center mb-3">ğŸ“š Helpful Resources</h2>
      <p class="text-muted text-center mb-4">
        Support lines and websites for childrenâ€™s mental health and digital wellbeing.
      </p>
      <div class="resource-card mb-3">
        <div class="resource-icon">ğŸ§’</div>
        <div>
          <h5 class="resource-title">Beyond Blue</h5>
          <p>Support for anxiety, depression, and mental health.</p>
          <a href="https://www.beyondblue.org.au/" target="_blank">Visit Beyond Blue</a>
        </div>
      </div>
      <div class="resource-card mb-3">
        <div class="resource-icon">ğŸ“</div>
        <div>
          <h5 class="resource-title">Kids Helpline</h5>
          <p>Support for kids dealing with anxiety, bullying, or other issues.</p>
          <a href="https://kidshelpline.com.au/" target="_blank">Visit Kids Helpline</a>
        </div>
      </div>
      <div class="resource-card">
        <div class="resource-icon">ğŸ‘ª</div>
        <div>
          <h5 class="resource-title">Raising Children Network</h5>
          <p>Videos, articles, and apps covering parenting topics by age group.</p>
          <a href="https://raisingchildren.net.au/" target="_blank">Visit Raising Children Network</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='parent.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const nativePicker = document.querySelector(".nativeWeekPicker");
    const fallbackPicker = document.querySelector(".fallbackWeekPicker");
    const fallbackLabel = document.querySelector(".fallbackLabel");
    const testInput = document.createElement("input");

    fallbackPicker.style.display = "none";
    fallbackLabel.style.display = "none";

    testInput.type = "week";
    if (testInput.type === "text") {
      nativePicker.style.display = "none";
      fallbackPicker.style.display = "block";
      fallbackLabel.style.display = "block";

      const yearSelect = document.getElementById("fallbackYear");
      const weekSelect = document.getElementById("fallbackWeek");

      populateYears();
      populateWeeks(yearSelect.value);

      yearSelect.addEventListener("change", () => {
        populateWeeks(yearSelect.value);
      });
    }

    function getISOWeekNumber(d) {
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    }

    function weeksInYear(year) {
      return getISOWeekNumber(new Date(year, 11, 28));
    }

    function getISOWeekStart(year, week) {
      const jan4 = new Date(year, 0, 4);
      const day = jan4.getDay() || 7;
      const mon = new Date(jan4);
      mon.setDate(jan4.getDate() - (day - 1) + (week - 1) * 7);
      return mon;
    }

    function formatDate(d) {
      return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
    }

    function populateYears() {
      const select = document.getElementById("fallbackYear");
      const currentYear = new Date().getFullYear();
      for (let y = currentYear - 5; y <= currentYear + 5; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (y === currentYear) opt.selected = true;
        select.appendChild(opt);
      }
    }

    function populateWeeks(year) {
      const select = document.getElementById("fallbackWeek");
      select.innerHTML = "";
      const total = weeksInYear(parseInt(year, 10));
      for (let i = 1; i <= total; i++) {
        const start = getISOWeekStart(year, i);
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        const num = i < 10 ? `0${i}` : `${i}`;
        const opt = document.createElement("option");
        opt.value = num;
        opt.textContent = `${num} (${formatDate(start)} â€“ ${formatDate(end)})`;
        select.appendChild(opt);
      }
    }
  });
</script>
{% endblock %}
